services:
  n8n:
    image: n8nio/n8n:latest
    container_name: expenseflow-n8n
    ports:
      - "5678:5678"
    env_file:
      - .env
    volumes:
      - ./n8n_data:/home/node/.n8n
    depends_on:
      db-preflight:
        condition: service_completed_successfully

  postgres:
    image: postgres:16
    container_name: expenseflow-postgres
    environment:
      - POSTGRES_USER=expenseflow
      - POSTGRES_PASSWORD=expenseflow
      - POSTGRES_DB=expenseflow
    ports:
      - "5432:5432"
    volumes:
      - expenseflow_pg:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U expenseflow -d expenseflow"]
      interval: 3s
      timeout: 3s
      retries: 20

  db-preflight:
    image: postgres:16
    container_name: expenseflow-db-preflight
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - PGPASSWORD=expenseflow
    volumes:
      - ./db/bootstrap:/bootstrap:ro
    command: >
      sh -c "
        echo 'Running DB preflight...';
        psql -h postgres -U expenseflow -d expenseflow -v ON_ERROR_STOP=1 -f /bootstrap/001_expenseflow_bootstrap.sql;
        echo 'DB preflight done.';
      "

volumes:
  expenseflow_pg:
